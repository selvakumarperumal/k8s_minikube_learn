# ==============================================================================
# POD NETWORKING DEMONSTRATION EXAMPLES
# ==============================================================================
# These examples demonstrate pod networking concepts in Kubernetes
#
# PREREQUISITES:
#   - Minikube with CNI (calico recommended)
#   - kubectl configured
#
# USAGE:
#   kubectl apply -f 01-pod-networking-demos.yaml
#   kubectl delete -f 01-pod-networking-demos.yaml
# ==============================================================================

---
# ==============================================================================
# EXAMPLE 1: BASIC POD FOR NETWORK EXPLORATION
# ==============================================================================
# A simple pod with networking tools for exploring pod networking
#
# DIAGRAM:
# ┌────────────────────────────────────────────────────────────────────────────┐
# │                          POD: network-explorer                              │
# ├────────────────────────────────────────────────────────────────────────────┤
# │                                                                             │
# │   Container: explorer                                                       │
# │   ┌───────────────────────────────────────────────────────────────────┐   │
# │   │  Image: nicolaka/netshoot (networking tools)                       │   │
# │   │                                                                     │   │
# │   │  Available commands:                                                │   │
# │   │  • ip addr, ip route, ip neigh                                     │   │
# │   │  • ping, traceroute, curl, wget                                    │   │
# │   │  • tcpdump, netstat, ss                                            │   │
# │   │  • nslookup, dig                                                   │   │
# │   └───────────────────────────────────────────────────────────────────┘   │
# │                                                                             │
# │   Network Namespace:                                                        │
# │   ┌───────────────────────────────────────────────────────────────────┐   │
# │   │  eth0: Pod IP (e.g., 10.244.0.X)                                   │   │
# │   │  lo: 127.0.0.1                                                     │   │
# │   └───────────────────────────────────────────────────────────────────┘   │
# │                                                                             │
# └────────────────────────────────────────────────────────────────────────────┘
# ------------------------------------------------------------------------------
apiVersion: v1
kind: Pod
metadata:
  name: network-explorer
  namespace: default
  labels:
    app: network-explorer
    purpose: demo
spec:
  containers:
    - name: explorer
      # nicolaka/netshoot contains lots of networking tools
      image: nicolaka/netshoot
      command: ["sleep", "86400"] # Sleep for 24 hours
      # Explore commands:
      # kubectl exec -it network-explorer -- ip addr
      # kubectl exec -it network-explorer -- ip route
      # kubectl exec -it network-explorer -- cat /etc/resolv.conf
      # kubectl exec -it network-explorer -- ping <other-pod-ip>
      # kubectl exec -it network-explorer -- traceroute <other-pod-ip>
      resources:
        requests:
          memory: "64Mi"
          cpu: "100m"
        limits:
          memory: "128Mi"
          cpu: "200m"

---
# ==============================================================================
# EXAMPLE 2: MULTI-CONTAINER POD (Shared Network Namespace)
# ==============================================================================
# Demonstrates how containers in the same pod share network namespace
#
# DIAGRAM:
# ┌────────────────────────────────────────────────────────────────────────────┐
# │                      POD: shared-network-demo                               │
# ├────────────────────────────────────────────────────────────────────────────┤
# │                                                                             │
# │  ┌─────────────────────────────────────────────────────────────────────┐  │
# │  │              SHARED NETWORK NAMESPACE                                │  │
# │  │                                                                      │  │
# │  │  eth0: 10.244.0.X                                                   │  │
# │  │  lo: 127.0.0.1                                                      │  │
# │  │                                                                      │  │
# │  │       ┌────────────────┐        ┌────────────────┐                  │  │
# │  │       │   Container 1  │        │   Container 2  │                  │  │
# │  │       │   web (nginx)  │        │   sidecar      │                  │  │
# │  │       │   Port: 80     │◄──────►│   (curl)       │                  │  │
# │  │       └────────────────┘        └────────────────┘                  │  │
# │  │                                                                      │  │
# │  │  Container 2 can reach Container 1 via localhost:80                 │  │
# │  │  because they share the same network namespace!                     │  │
# │  │                                                                      │  │
# │  └─────────────────────────────────────────────────────────────────────┘  │
# │                                                                             │
# └────────────────────────────────────────────────────────────────────────────┘
# ------------------------------------------------------------------------------
apiVersion: v1
kind: Pod
metadata:
  name: shared-network-demo
  namespace: default
  labels:
    app: shared-network-demo
    purpose: demo
spec:
  containers:
    # Container 1: Web server
    - name: web
      image: nginx:alpine
      ports:
        - containerPort: 80
      resources:
        requests:
          memory: "64Mi"
          cpu: "100m"
        limits:
          memory: "128Mi"
          cpu: "200m"

    # Container 2: Sidecar that can access web via localhost
    - name: sidecar
      image: curlimages/curl
      # This sidecar continuously checks the web server via localhost
      command:
        - /bin/sh
        - -c
        - |
          while true; do
            echo "=== Checking web server at localhost:80 ==="
            curl -s localhost:80 | head -5
            echo ""
            sleep 10
          done
      resources:
        requests:
          memory: "32Mi"
          cpu: "50m"
        limits:
          memory: "64Mi"
          cpu: "100m"

---
# ==============================================================================
# EXAMPLE 3: POD-TO-POD COMMUNICATION TEST
# ==============================================================================
# Two pods for testing pod-to-pod network connectivity
#
# DIAGRAM:
# ┌─────────────────────────┐              ┌─────────────────────────┐
# │    POD: http-server     │              │    POD: http-client     │
# │    ─────────────────    │              │    ─────────────────    │
# │    IP: 10.244.0.X       │◄────────────►│    IP: 10.244.0.Y       │
# │    Port: 8080           │   Pod-to-Pod │                         │
# │    Image: hashicorp/    │  Direct Comm │    Image: curlimages/   │
# │            http-echo    │              │            curl         │
# └─────────────────────────┘              └─────────────────────────┘
# ------------------------------------------------------------------------------
apiVersion: v1
kind: Pod
metadata:
  name: http-server
  namespace: default
  labels:
    app: http-server
    purpose: demo
spec:
  containers:
    - name: server
      image: hashicorp/http-echo
      args:
        - "-text=Hello from http-server pod!"
        - "-listen=:8080"
      ports:
        - containerPort: 8080
      resources:
        requests:
          memory: "32Mi"
          cpu: "50m"
        limits:
          memory: "64Mi"
          cpu: "100m"

---
apiVersion: v1
kind: Pod
metadata:
  name: http-client
  namespace: default
  labels:
    app: http-client
    purpose: demo
spec:
  containers:
    - name: client
      image: curlimages/curl
      command:
        - /bin/sh
        - -c
        - |
          echo "Waiting for http-server to be ready..."
          sleep 5
          echo ""
          echo "=== Testing Pod-to-Pod Communication ==="
          echo ""
          # Get server pod IP (you need to set this manually or use DNS)
          # For demo, using nslookup if you create a Service
          echo "To test manually, run:"
          echo "kubectl exec http-client -- curl http://<http-server-pod-ip>:8080"
          echo ""
          sleep infinity
      resources:
        requests:
          memory: "32Mi"
          cpu: "50m"
        limits:
          memory: "64Mi"
          cpu: "100m"

---
# ==============================================================================
# EXAMPLE 4: HOST NETWORK POD
# ==============================================================================
# Pod that uses the host's network namespace (not isolated)
#
# DIAGRAM:
# ┌────────────────────────────────────────────────────────────────────────────┐
# │                               NODE                                          │
# │                                                                             │
# │   Host Network Namespace                                                    │
# │   ┌──────────────────────────────────────────────────────────────────────┐│
# │   │                                                                       ││
# │   │   eth0: 192.168.49.2 (Node IP)                                       ││
# │   │   lo: 127.0.0.1                                                       ││
# │   │   docker0, cni0, etc.                                                 ││
# │   │                                                                       ││
# │   │         ┌─────────────────────────────┐                              ││
# │   │         │   POD: host-network-demo    │                              ││
# │   │         │   hostNetwork: true         │                              ││
# │   │         │                             │                              ││
# │   │         │   Sees same interfaces as   │                              ││
# │   │         │   the host node!            │                              ││
# │   │         └─────────────────────────────┘                              ││
# │   │                                                                       ││
# │   └──────────────────────────────────────────────────────────────────────┘│
# │                                                                             │
# └────────────────────────────────────────────────────────────────────────────┘
#
# WARNING: hostNetwork bypasses pod network isolation!
# Use only when absolutely necessary (e.g., network plugins, monitoring)
# ------------------------------------------------------------------------------
apiVersion: v1
kind: Pod
metadata:
  name: host-network-demo
  namespace: default
  labels:
    app: host-network-demo
    purpose: demo
spec:
  # USE HOST NETWORK - Pod uses node's network namespace
  hostNetwork: true
  containers:
    - name: explorer
      image: nicolaka/netshoot
      command: ["sleep", "3600"]
      # When you run: kubectl exec host-network-demo -- ip addr
      # You'll see the NODE's interfaces, not isolated pod interfaces!
      resources:
        requests:
          memory: "64Mi"
          cpu: "100m"
        limits:
          memory: "128Mi"
          cpu: "200m"

---
# ==============================================================================
# EXAMPLE 5: DNS TESTING POD
# ==============================================================================
# Pod for testing Kubernetes DNS resolution
#
# DIAGRAM:
# ┌────────────────────────────────────────────────────────────────────────────┐
# │                          DNS RESOLUTION FLOW                                │
# ├────────────────────────────────────────────────────────────────────────────┤
# │                                                                             │
# │   Pod: dns-tester                          kube-system namespace           │
# │   ┌─────────────────────┐                 ┌─────────────────────┐          │
# │   │  /etc/resolv.conf   │                 │    CoreDNS Pod      │          │
# │   │  ─────────────────  │    DNS Query    │    ─────────────    │          │
# │   │  nameserver         │────────────────►│    10.96.0.10       │          │
# │   │    10.96.0.10       │                 │                     │          │
# │   │  search default.    │◄────────────────│    Returns IP       │          │
# │   │    svc.cluster.local│    DNS Response │                     │          │
# │   └─────────────────────┘                 └─────────────────────┘          │
# │                                                                             │
# │   DNS Names Resolved:                                                       │
# │   • kubernetes.default.svc.cluster.local → 10.96.0.1 (API Server)          │
# │   • <service>.<namespace>.svc.cluster.local → ClusterIP                    │
# │   • <pod-ip>.<namespace>.pod.cluster.local → Pod IP                        │
# │                                                                             │
# └────────────────────────────────────────────────────────────────────────────┘
# ------------------------------------------------------------------------------
apiVersion: v1
kind: Pod
metadata:
  name: dns-tester
  namespace: default
  labels:
    app: dns-tester
    purpose: demo
spec:
  containers:
    - name: tester
      image: busybox:1.36
      command:
        - /bin/sh
        - -c
        - |
          echo "=== DNS Configuration ==="
          cat /etc/resolv.conf
          echo ""
          echo "=== Testing DNS Resolution ==="
          echo ""
          echo "1. Resolving kubernetes service:"
          nslookup kubernetes.default.svc.cluster.local
          echo ""
          echo "2. Resolving kube-dns:"
          nslookup kube-dns.kube-system.svc.cluster.local
          echo ""
          echo "DNS tests complete. Sleeping..."
          sleep infinity
      resources:
        requests:
          memory: "32Mi"
          cpu: "50m"
        limits:
          memory: "64Mi"
          cpu: "100m"
