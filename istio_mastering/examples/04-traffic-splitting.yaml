# Traffic Splitting Examples
# ============================================================================
# Demonstrates canary and blue-green deployment patterns
# ============================================================================

---
# =============================================================================
# CANARY DEPLOYMENT - Gradual rollout
# =============================================================================
# Start with 10% traffic to new version, gradually increase

apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: my-app-canary
spec:
  hosts:
    - my-app
  http:
    - route:
        # 90% to stable version
        - destination:
            host: my-app
            subset: stable
          weight: 90
        # 10% to canary version
        - destination:
            host: my-app
            subset: canary
          weight: 10

---
# =============================================================================
# BLUE-GREEN DEPLOYMENT - Instant switch
# =============================================================================
# All traffic to one version, switch instantly

apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: my-app-blue-green
spec:
  hosts:
    - my-app
  http:
    - route:
        # All traffic to green (new version)
        # Change to 'blue' to rollback
        - destination:
            host: my-app
            subset: green
          weight: 100

---
# =============================================================================
# DESTINATION RULE - Define blue/green/canary subsets
# =============================================================================

apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: my-app-versions
spec:
  host: my-app
  subsets:
    - name: stable
      labels:
        version: stable
    - name: canary
      labels:
        version: canary
    - name: blue
      labels:
        deployment: blue
    - name: green
      labels:
        deployment: green
# ============================================================================
# HOW TO USE
# ============================================================================
#
# CANARY DEPLOYMENT:
# ------------------
# 1. Deploy stable version with label: version=stable
# 2. Deploy canary version with label: version=canary
# 3. Apply canary VirtualService
# 4. Gradually change weights: 90/10 → 70/30 → 50/50 → 0/100
# 5. When confident, make canary the new stable
#
# BLUE-GREEN DEPLOYMENT:
# ----------------------
# 1. Deploy blue version with label: deployment=blue (current)
# 2. Deploy green version with label: deployment=green (new)
# 3. Apply blue-green VirtualService pointing to green
# 4. Test green version
# 5. If issues, change subset back to 'blue'
#
# COMMANDS:
# ---------
# kubectl apply -f 04-traffic-splitting.yaml
# kubectl get vs my-app-canary -o yaml
#
# Test canary (run multiple times to see distribution):
# for i in {1..100}; do curl -s http://my-app:8080/version; done | sort | uniq -c
#
# ============================================================================
