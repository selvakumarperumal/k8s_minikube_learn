# ============================================================================
# ISTIO SERVICE MESH - Complete Examples (with Gateway API)
# ============================================================================
# This file contains Istio configuration examples using Kubernetes Gateway API
#
# PREREQUISITES:
# --------------
# 1. Start Minikube with enough resources:
#    minikube start --cpus=4 --memory=8192
#
# 2. Install Kubernetes Gateway API CRDs:
#    kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.2.0/standard-install.yaml
#
# 3. Install Istio:
#    curl -L https://istio.io/downloadIstio | sh -
#    cd istio-*
#    export PATH=$PWD/bin:$PATH
#    istioctl install --set profile=demo -y
#
# 4. Verify Gateway API GatewayClass:
#    kubectl get gatewayclass
#    # Should show: istio   istio.io/gateway-controller   True
#
# 5. Enable sidecar injection:
#    kubectl label namespace default istio-injection=enabled
#
# HOW TO RUN:
# -----------
# 1. Apply examples:
#    kubectl apply -f 05-istio-examples.yaml
#
# 2. Wait for pods:
#    kubectl wait --for=condition=ready pod --all --timeout=120s
#
# 3. Get Gateway address:
#    kubectl get gateway myapp-gateway -o jsonpath='{.status.addresses[0].value}'
#
# 4. Test (see individual examples)
#
# 5. Cleanup:
#    kubectl delete -f 05-istio-examples.yaml
#
# ============================================================================

---
# ============================================================================
# SAMPLE APPLICATION: Two versions for traffic management
# ============================================================================

# Version 1 Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-v1
  labels:
    app: myapp
    version: v1
spec:
  replicas: 2
  selector:
    matchLabels:
      app: myapp
      version: v1
  template:
    metadata:
      labels:
        app: myapp
        version: v1
    spec:
      containers:
        - name: myapp
          image: hashicorp/http-echo
          args:
            - "-text=Hello from VERSION 1!"
          ports:
            - containerPort: 5678
          resources:
            requests:
              cpu: 50m
              memory: 32Mi

---
# Version 2 Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-v2
  labels:
    app: myapp
    version: v2
spec:
  replicas: 2
  selector:
    matchLabels:
      app: myapp
      version: v2
  template:
    metadata:
      labels:
        app: myapp
        version: v2
    spec:
      containers:
        - name: myapp
          image: hashicorp/http-echo
          args:
            - "-text=Hello from VERSION 2! (New features!)"
          ports:
            - containerPort: 5678
          resources:
            requests:
              cpu: 50m
              memory: 32Mi

---
# Service (selects both v1 and v2)
apiVersion: v1
kind: Service
metadata:
  name: myapp
  labels:
    app: myapp
spec:
  selector:
    app: myapp # Matches both v1 and v2
  ports:
    - port: 80
      targetPort: 5678
      name: http

---
# ============================================================================
# EXAMPLE 1: Gateway (Kubernetes Gateway API)
# ============================================================================
# Modern way to define external traffic entry point in Istio
# Uses standard Kubernetes Gateway API instead of Istio-specific Gateway

apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: myapp-gateway
spec:
  # ---------------------------------------------------------------------------
  # gatewayClassName: Use Istio's Gateway controller
  # ---------------------------------------------------------------------------
  # Istio automatically registers this GatewayClass
  gatewayClassName: istio

  # ---------------------------------------------------------------------------
  # listeners: Define ports, protocols, and TLS
  # ---------------------------------------------------------------------------
  listeners:
    # HTTP listener on port 80
    - name: http
      protocol: HTTP
      port: 80
      # Which routes can attach to this listener
      allowedRoutes:
        namespaces:
          from: Same # Only routes from same namespace

# NOTE: When you create this Gateway, Istio automatically:
# - Creates a Deployment (gateway pods)
# - Creates a Service (LoadBalancer type)
# - No need for istio-ingressgateway!

# HOW TO TEST:
# ------------
# # Wait for Gateway to be programmed
# kubectl wait --for=condition=programmed gateway myapp-gateway --timeout=60s
#
# # Get Gateway address
# export GATEWAY_IP=$(kubectl get gateway myapp-gateway -o jsonpath='{.status.addresses[0].value}')
# echo "Gateway IP: $GATEWAY_IP"
#
# # For Minikube, start tunnel in separate terminal:
# minikube tunnel
#
# # Test (after HTTPRoute/VirtualService is applied)
# curl http://$GATEWAY_IP

---
# ============================================================================
# EXAMPLE 2: HTTPRoute - Simple Routing (Gateway API)
# ============================================================================
# Pure Gateway API routing without VirtualService

apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: myapp-route-simple
spec:
  # ---------------------------------------------------------------------------
  # parentRefs: Attach to Gateway
  # ---------------------------------------------------------------------------
  parentRefs:
    - name: myapp-gateway

  # ---------------------------------------------------------------------------
  # rules: Define routing
  # ---------------------------------------------------------------------------
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: myapp
          port: 80

# HOW TO TEST:
# ------------
# # Get Gateway IP
# export GATEWAY_IP=$(kubectl get gateway myapp-gateway -o jsonpath='{.status.addresses[0].value}')
#
# # Test
# curl http://$GATEWAY_IP
# # Output: Hello from VERSION 1! or VERSION 2! (load balanced)

---
# ============================================================================
# EXAMPLE 3: VirtualService - All Traffic to V1 (with Gateway API Gateway)
# ============================================================================
# VirtualService works with Kubernetes Gateway API Gateway
# Use VirtualService when you need subset routing or advanced features

apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: myapp-all-v1
spec:
  # ---------------------------------------------------------------------------
  # hosts: Which services this applies to
  # ---------------------------------------------------------------------------
  hosts:
    - myapp # Internal service name

  # ---------------------------------------------------------------------------
  # gateways: Reference to K8s Gateway API Gateway
  # ---------------------------------------------------------------------------
  gateways:
    - myapp-gateway # K8s Gateway API Gateway (same namespace)
    - mesh # Internal mesh traffic

  # ---------------------------------------------------------------------------
  # http: HTTP routing rules
  # ---------------------------------------------------------------------------
  http:
    - route:
        - destination:
            host: myapp
            subset: v1 # All to v1
          weight: 100

# HOW TO TEST:
# ------------
# # Apply this VirtualService
# kubectl apply -f <this-section>
#
# # Test multiple times - should always return V1
# for i in {1..10}; do curl -s http://$GATEWAY_IP; done
# # Output: Hello from VERSION 1! (10 times)

---
# ============================================================================
# EXAMPLE 4: DestinationRule - Define Subsets (Versions)
# ============================================================================
# Subsets define how to identify different versions
# Required for VirtualService subset routing

apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: myapp-destination
spec:
  # ---------------------------------------------------------------------------
  # host: Which service this applies to
  # ---------------------------------------------------------------------------
  host: myapp

  # ---------------------------------------------------------------------------
  # subsets: Define versions using pod labels
  # ---------------------------------------------------------------------------
  subsets:
    - name: v1
      labels:
        version: v1 # Pods with version=v1

    - name: v2
      labels:
        version: v2 # Pods with version=v2

# NOTE: DestinationRule MUST be applied for VirtualService subsets to work!

---
# ============================================================================
# EXAMPLE 5: HTTPRoute - Canary Deployment (90/10) - Gateway API
# ============================================================================
# Pure Gateway API traffic splitting without VirtualService

apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: myapp-canary-httproute
spec:
  parentRefs:
    - name: myapp-gateway
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        # Note: With HTTPRoute, you need separate Services for each version
        # Or use VirtualService with DestinationRule subsets (next example)
        - name: myapp # This will load-balance across all pods
          port: 80

# For true canary with subsets, use VirtualService below:

---
# ============================================================================
# EXAMPLE 6: VirtualService - Canary Deployment (90/10)
# ============================================================================
# Route 90% to v1, 10% to v2 (canary) - requires DestinationRule subsets

apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: myapp-canary
spec:
  hosts:
    - myapp
  gateways:
    - myapp-gateway # K8s Gateway API Gateway
    - mesh
  http:
    - route:
        - destination:
            host: myapp
            subset: v1
          weight: 90 # 90% to v1
        - destination:
            host: myapp
            subset: v2
          weight: 10 # 10% to v2 (canary)

# HOW TO TEST:
# ------------
# export GATEWAY_IP=$(kubectl get gateway myapp-gateway -o jsonpath='{.status.addresses[0].value}')
#
# # Test multiple times - should see ~90% v1, ~10% v2
# for i in {1..20}; do curl -s http://$GATEWAY_IP; done
# # Mix of VERSION 1 and VERSION 2 responses

---
# ============================================================================
# EXAMPLE 7: VirtualService - Header-Based Routing
# ============================================================================
# Route based on HTTP headers (A/B testing, feature flags)
# VirtualService is needed for header-based routing with subsets

apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: myapp-header-routing
spec:
  hosts:
    - myapp
  gateways:
    - myapp-gateway # K8s Gateway API Gateway
    - mesh
  http:
    # ---------------------------------------------------------------------------
    # Rule 1: If header x-version=v2, route to v2
    # ---------------------------------------------------------------------------
    - match:
        - headers:
            x-version:
              exact: "v2"
      route:
        - destination:
            host: myapp
            subset: v2

    # ---------------------------------------------------------------------------
    # Rule 2: If header x-user-type=beta, route to v2
    # ---------------------------------------------------------------------------
    - match:
        - headers:
            x-user-type:
              exact: "beta"
      route:
        - destination:
            host: myapp
            subset: v2

    # ---------------------------------------------------------------------------
    # Default: Route to v1
    # ---------------------------------------------------------------------------
    - route:
        - destination:
            host: myapp
            subset: v1

# HOW TO TEST:
# ------------
# export GATEWAY_IP=$(kubectl get gateway myapp-gateway -o jsonpath='{.status.addresses[0].value}')
#
# # Default - goes to v1
# curl http://$GATEWAY_IP
# # Output: Hello from VERSION 1!
#
# # With x-version header - goes to v2
# curl -H "x-version: v2" http://$GATEWAY_IP
# # Output: Hello from VERSION 2!
#
# # With x-user-type header - goes to v2
# curl -H "x-user-type: beta" http://$GATEWAY_IP
# # Output: Hello from VERSION 2!

---
# ============================================================================
# EXAMPLE 8: VirtualService - Path-Based Routing
# ============================================================================
# Different paths go to different versions

apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: myapp-path-routing
spec:
  hosts:
    - myapp
  gateways:
    - myapp-gateway # K8s Gateway API Gateway
  http:
    # ---------------------------------------------------------------------------
    # /v2/* goes to v2
    # ---------------------------------------------------------------------------
    - match:
        - uri:
            prefix: /v2
      rewrite:
        uri: / # Rewrite /v2/... to /...
      route:
        - destination:
            host: myapp
            subset: v2

    # ---------------------------------------------------------------------------
    # Everything else goes to v1
    # ---------------------------------------------------------------------------
    - route:
        - destination:
            host: myapp
            subset: v1

# HOW TO TEST:
# ------------
# export GATEWAY_IP=$(kubectl get gateway myapp-gateway -o jsonpath='{.status.addresses[0].value}')
#
# curl http://$GATEWAY_IP/
# # Output: Hello from VERSION 1!
#
# curl http://$GATEWAY_IP/v2/
# # Output: Hello from VERSION 2!

---
# ============================================================================
# EXAMPLE 9: DestinationRule - Circuit Breaker
# ============================================================================
# Protect service from cascading failures
# Circuit breaker is an Istio-specific feature (not in Gateway API)

apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: myapp-circuit-breaker
spec:
  host: myapp

  trafficPolicy:
    # ---------------------------------------------------------------------------
    # connectionPool: Limit connections
    # ---------------------------------------------------------------------------
    connectionPool:
      tcp:
        maxConnections: 100 # Max TCP connections
      http:
        http1MaxPendingRequests: 100 # Max pending HTTP/1.1 requests
        http2MaxRequests: 1000 # Max active HTTP/2 requests
        maxRequestsPerConnection: 10 # Close connection after N requests
        maxRetries: 3 # Max concurrent retries

    # ---------------------------------------------------------------------------
    # outlierDetection: Eject failing hosts
    # ---------------------------------------------------------------------------
    outlierDetection:
      consecutive5xxErrors: 5 # Eject after 5 consecutive 5xx errors
      interval: 30s # Check every 30 seconds
      baseEjectionTime: 30s # Eject for at least 30 seconds
      maxEjectionPercent: 50 # Don't eject more than 50% of hosts
      minHealthPercent: 30 # Need at least 30% healthy hosts

  subsets:
    - name: v1
      labels:
        version: v1
    - name: v2
      labels:
        version: v2

# NOTE: Circuit breaker is an Istio-specific feature not available in Gateway API

---
# ============================================================================
# EXAMPLE 10: VirtualService - Retries and Timeouts
# ============================================================================
# Automatic retries and request timeouts
# These are Istio-specific features not fully available in Gateway API yet

apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: myapp-resilience
spec:
  hosts:
    - myapp
  gateways:
    - myapp-gateway # K8s Gateway API Gateway
    - mesh
  http:
    - route:
        - destination:
            host: myapp
            subset: v1

      # ---------------------------------------------------------------------------
      # timeout: Max request time (Istio-specific)
      # ---------------------------------------------------------------------------
      timeout: 10s

      # ---------------------------------------------------------------------------
      # retries: Automatic retry on failure (Istio-specific)
      # ---------------------------------------------------------------------------
      retries:
        attempts: 3 # Retry up to 3 times
        perTryTimeout: 2s # Timeout per attempt
        retryOn: gateway-error,connect-failure,refused-stream,5xx

# NOTE: Gateway API has basic timeout support, but retries are Istio-specific

---
# ============================================================================
# EXAMPLE 11: Fault Injection (Testing)
# ============================================================================
# Inject faults to test resilience
# This is an Istio-specific feature for chaos testing

apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: myapp-fault-injection
spec:
  hosts:
    - myapp
  gateways:
    - myapp-gateway # K8s Gateway API Gateway
  http:
    - route:
        - destination:
            host: myapp
            subset: v1

      # ---------------------------------------------------------------------------
      # fault: Inject failures for testing (Istio-specific)
      # ---------------------------------------------------------------------------
      fault:
        # Inject delays
        delay:
          percentage:
            value: 10 # 10% of requests
          fixedDelay: 5s # 5 second delay

        # Inject errors
        abort:
          percentage:
            value: 5 # 5% of requests
          httpStatus: 500 # Return 500 error

# HOW TO TEST:
# ------------
# export GATEWAY_IP=$(kubectl get gateway myapp-gateway -o jsonpath='{.status.addresses[0].value}')
#
# # Some requests will be delayed or fail
# for i in {1..20}; do
#   time curl -s http://$GATEWAY_IP
# done
# # ~10% will take 5+ seconds
# # ~5% will return error

---
# ============================================================================
# EXAMPLE 12: PeerAuthentication - Enable mTLS
# ============================================================================
# Mutual TLS between services (Istio security feature)

apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: default
spec:
  # ---------------------------------------------------------------------------
  # mtls mode:
  # - PERMISSIVE: Accept both mTLS and plain text
  # - STRICT: Only accept mTLS
  # - DISABLE: No mTLS
  # ---------------------------------------------------------------------------
  mtls:
    mode: STRICT

# NOTE: mTLS works the same regardless of whether you use
# Gateway API or Istio Gateway for ingress

---
# ============================================================================
# EXAMPLE 13: AuthorizationPolicy - Access Control
# ============================================================================
# Control which services can access which (Istio security feature)

# Deny all by default
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: deny-all
  namespace: default
spec: {} # Empty spec = deny all

---
# Allow specific access
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-frontend
  namespace: default
spec:
  # ---------------------------------------------------------------------------
  # selector: Which workloads this applies to
  # ---------------------------------------------------------------------------
  selector:
    matchLabels:
      app: myapp

  # ---------------------------------------------------------------------------
  # action: ALLOW, DENY, or CUSTOM
  # ---------------------------------------------------------------------------
  action: ALLOW

  # ---------------------------------------------------------------------------
  # rules: When to allow
  # ---------------------------------------------------------------------------
  rules:
    - from:
        - source:
            # Allow from specific service accounts
            principals:
              - "cluster.local/ns/default/sa/frontend"
            # Or from specific namespaces
            namespaces:
              - "frontend"
      to:
        - operation:
            methods: ["GET", "POST"]
            paths: ["/api/*", "/health"]

# NOTE: AuthorizationPolicy works the same with Gateway API or Istio Gateway

---
# ============================================================================
# EXAMPLE 14: RequestAuthentication - JWT Validation
# ============================================================================
# Validate JWT tokens (Istio security feature)

apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: jwt-auth
  namespace: default
spec:
  selector:
    matchLabels:
      app: myapp
  jwtRules:
    - issuer: "https://auth.example.com"
      jwksUri: "https://auth.example.com/.well-known/jwks.json"
      audiences:
        - "myapp"
# HOW TO TEST:
# ------------
# export GATEWAY_IP=$(kubectl get gateway myapp-gateway -o jsonpath='{.status.addresses[0].value}')
#
# # Requests without valid JWT will be rejected
# curl http://$GATEWAY_IP
# # 401 Unauthorized
#
# # With valid JWT
# curl -H "Authorization: Bearer <token>" http://$GATEWAY_IP
# # Success

# ============================================================================
# ISTIO + GATEWAY API COMMANDS CHEAT SHEET
# ============================================================================
#
# # Install Gateway API CRDs
# kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.2.0/standard-install.yaml
#
# # Install Istio
# istioctl install --set profile=demo -y
#
# # Verify Gateway API GatewayClass
# kubectl get gatewayclass
#
# # Get Gateway address
# kubectl get gateway myapp-gateway -o jsonpath='{.status.addresses[0].value}'
#
# # Check Gateway status
# kubectl describe gateway myapp-gateway
#
# # Check HTTPRoute status
# kubectl describe httproute myapp-route
#
# # Enable injection
# kubectl label namespace default istio-injection=enabled
#
# # View proxy config
# istioctl proxy-config routes deploy/myapp-v1
#
# # Analyze configuration
# istioctl analyze
#
# # Open dashboards
# istioctl dashboard kiali
# istioctl dashboard grafana
# istioctl dashboard jaeger
#
# # Check mTLS
# istioctl x authz check deployment/myapp-v1
#
# # Debug proxy
# istioctl proxy-status
#
# ============================================================================
